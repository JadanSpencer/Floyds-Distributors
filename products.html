<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Products | Floyd's Distributors</title>
    <link rel="stylesheet" href="products.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <h1>Floyd's Distributors</h1>
            </div>
            <!--<div class="search-container">
                <input type="text" placeholder="Search products..." class="search-input" id="searchInput">
                <button class="search-btn" id="searchBtn">üîç</button>
            </div>-->
            <nav class="navbar">
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li class="dropdown">
                        <a href="products.html">Products <span class="dropdown-arrow">‚ñº</span></a>
                        <ul class="dropdown-menu">
                            <li><a href="products.html">All Products</a></li>
                            <li><a href="category.html?cat=food-containers">Food Containers</a></li>
                            <li><a href="category.html?cat=eco-friendly">Eco-Friendly Packaging</a></li>
                            <li><a href="category.html?cat=custom">Custom Solutions</a></li>
                        </ul>
                    </li>
                    <li><a href="delivery.html">Delivery</a></li>
                    <li><a href="about.html">About Us</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
                <div class="cart-icon">
                    <span class="cart-icon-symbol">üõí</span>
                    <span class="cart-count">0</span>
                </div>
                <div class="hamburger">‚ò∞</div>
            </nav>
        </div>
    </header>

    <!-- Products Main Section -->
    <main class="product-main">
        <div class="container">
            <!-- Breadcrumb Navigation -->
            <nav class="breadcrumb">
                <a href="index.html">Home</a>
                <span> > </span>
                <a href="products.html">Products</a>
            </nav>

            <!-- Page Header with Search -->
            <div class="page-header">
                <h1>All Products</h1>
                <div class="search-container">
                    <input type="text" placeholder="Search products..." class="search-input" id="mobileSearchInput">
                    <button class="search-btn" id="mobileSearchBtn">üîç</button>
                </div>
            </div>

            <!-- Product Filters (optional) -->
            <div class="product-filters">
                <div class="filter-group">
                    <label for="categoryFilter">Category:</label>
                    <select id="categoryFilter" class="filter-select">
                      <option value="all">All Categories</option>
                      <option value="bags">Bags</option>
                      <option value="foodContainers">Food Containers</option>
                      <option value="cups">Cups</option>
                      <option value="lunchBoxes">Lunch Boxes</option>
                      <option value="eco-friendly">Eco-Friendly</option>
                      <option value="household-supplies">Household Supplies</option>
                      <option value="other">Other</option>
                  </select>
                </div>
                <div class="filter-group">
                    <label for="sortBy">Sort By:</label>
                    <select id="sortBy" class="filter-select">
                        <option value="featured">Featured</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="name-asc">Name: A-Z</option>
                        <option value="name-desc">Name: Z-A</option>
                    </select>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="products-grid" id="productsGrid">
                <!-- Products will be loaded here via JavaScript -->
            </div>

            <!-- Loading Indicator -->
            <div class="loading-indicator" id="loadingIndicator">
                <div class="spinner"></div>
                <p>Loading products...</p>
            </div>

            <!-- No Results Message (hidden by default) -->
            <div class="no-results" id="noResults" style="display: none;">
                <h3>No products found matching your search</h3>
                <p>Try adjusting your search or filters</p>
                <button class="btn btn-outline" id="resetFilters">Reset Filters</button>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col">
                    <h3>Floyd's Distributors</h3>
                    <p>Quality food packaging solutions for businesses of all sizes. Eco-friendly, durable, and customizable.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>

                <div class="footer-col">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="products.html">Products</a></li>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>

                <div class="footer-col">
                    <h3>Categories</h3>
                    <ul>
                        <li><a href="category.html?cat=food-containers">Food Containers</a></li>
                        <li><a href="category.html?cat=eco-friendly">Eco-Friendly Packaging</a></li>
                        <li><a href="category.html?cat=custom">Custom Solutions</a></li>
                    </ul>
                </div>

                <div class="footer-col">
                    <h3>Contact Us</h3>
                    <ul class="contact-info">
                        <li><i class="fas fa-map-marker-alt"></i> 123 Packaging Way, Portland, OR 97201</li>
                        <li><i class="fas fa-phone"></i> (800) 555-1234</li>
                        <li><i class="fas fa-envelope"></i> info@floydsdistributors.com</li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2024 Floyd's Distributors. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Cart Components -->
    <div class="cart-overlay"></div>
    <div class="cart-sidebar">
        <div class="cart-header">
            <h3>Your Cart (<span class="cart-count">0</span>)</h3>
            <button class="close-cart">√ó</button>
        </div>
        <div class="cart-items">
            <!-- Cart items will be added here dynamically -->
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <span>Total:</span>
                <span class="total-price">$0.00</span>
            </div>
            <button class="checkout-btn"><a href="checkout.html">Checkout</a></button>
        </div>
    </div>

      <script type="module">
    // Import Firebase functions from script.js
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBk4oAO4LVlrwgBgrdk9m2waZaeiB1nrqY",
      authDomain: "floyds-489c8.firebaseapp.com",
      databaseURL: "https://floyds-489c8-default-rtdb.firebaseio.com",
      projectId: "floyds-489c8",
      storageBucket: "floyds-489c8.appspot.com",
      messagingSenderId: "467837659879",
      appId: "1:467837659879:web:8fde5b1862184183ac9042",
      measurementId: "G-32RKBL830G"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Make db available globally
    window.db = db;

    // DOM Elements
    const productsGrid = document.getElementById('productsGrid');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const noResults = document.getElementById('noResults');
    const mobileSearchInput = document.getElementById('mobileSearchInput');
    const mobileSearchBtn = document.getElementById('mobileSearchBtn');
    const categoryFilter = document.getElementById('categoryFilter');
    const sortBy = document.getElementById('sortBy');
    const resetFilters = document.getElementById('resetFilters');

    // Initialize the page
    document.addEventListener('DOMContentLoaded', async () => {
        // Check for search query in URL
        const urlParams = new URLSearchParams(window.location.search);
        const searchQuery = urlParams.get('q');
        
        if (searchQuery) {
            if (mobileSearchInput) mobileSearchInput.value = searchQuery;
            handleSearch(searchQuery);
        } else {
            await displayProducts();
        }

        // Set up event listeners
        setupEventListeners();
    });

    // Set up all event listeners
    function setupEventListeners() {
        if (mobileSearchInput) {
            mobileSearchInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') handleSearch();
            });
        }
        
        if (mobileSearchBtn) mobileSearchBtn.addEventListener('click', () => handleSearch());
        
        if (categoryFilter) {
            categoryFilter.addEventListener('change', () => {
                // When category changes, we want to filter but keep any existing search term
                const searchTerm = mobileSearchInput?.value || '';
                displayProducts(searchTerm);
            });
        }
        
        if (sortBy) {
            sortBy.addEventListener('change', () => {
                const searchTerm = mobileSearchInput?.value || '';
                displayProducts(searchTerm);
            });
        }
        
        if (resetFilters) {
            resetFilters.addEventListener('click', () => {
                if (mobileSearchInput) mobileSearchInput.value = '';
                if (categoryFilter) categoryFilter.value = 'all';
                if (sortBy) sortBy.value = 'featured';
                displayProducts();
            });
        }
    }

    async function displayProducts(searchTerm = '') {
        console.log('Starting to display products...');
        loadingIndicator.style.display = 'flex';
        noResults.style.display = 'none';
        productsGrid.innerHTML = '';
        
        try {
            console.log('Fetching products from firestore...');
            const productsCol = collection(db, 'products');
            const snapshot = await getDocs(productsCol);
            console.log(`Found ${snapshot.size} products`);
            
            let products = snapshot.docs.map(doc => {
                const data = doc.data();
                return {
                    id: doc.id,
                    name: data.name || 'Unnamed Product',
                    price: typeof data.price === 'number' ? data.price.toFixed(2) : data.price,
                    description: data.description || 'No description available',
                    image: data.image || 'https://placehold.co/300x200?text=Product+Image',
                    category: data.category || 'other',
                    featured: data.featured || false,
                    stock: data.stock || 0
                };
            });

            // Apply search filter
            if (searchTerm && typeof searchTerm === 'string') {
                const lowerTerm = searchTerm.toLowerCase();
                products = products.filter(product => 
                    product.name.toLowerCase().includes(lowerTerm) || 
                    (product.description && product.description.toLowerCase().includes(lowerTerm))
                );
            }

            // Apply category filter
            const category = categoryFilter.value;
            if (category !== 'all') {
                products = products.filter(p => p.category === category);
            }

            // Apply sorting
            const sortOption = sortBy.value;
            products = sortProducts(products, sortOption);

            // Render products
            renderProducts(products);

            if (products.length === 0) {
                noResults.style.display = 'block';
            }
        } catch (error) {
            console.error("Error loading products:", error);
            noResults.style.display = 'block';
            noResults.innerHTML = `
                <h3>Error loading products</h3>
                <p>Please try again later</p>
            `;
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }

    async function handleSearch(searchTerm = null) {
        const term = searchTerm !== null ? searchTerm : (mobileSearchInput?.value || '');
        await displayProducts(term);
    }

    // Sort products based on selected option
    function sortProducts(products, sortOption) {
        switch(sortOption) {
            case 'price-low':
                return [...products].sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
            case 'price-high':
                return [...products].sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
            case 'name-asc':
                return [...products].sort((a, b) => a.name.localeCompare(b.name));
            case 'name-desc':
                return [...products].sort((a, b) => b.name.localeCompare(a.name));
            case 'featured':
            default:
                return [...products].sort((a, b) => (b.featured === a.featured) ? 0 : b.featured ? -1 : 1);
        }
    }

    // Render products to the grid
    function renderProducts(products) {
        productsGrid.innerHTML = '';
        
        products.forEach(product => {
            const stockStatus = getStockText(product.stock);
            const stockClass = getStockClass(product.stock);

            const imagePath = product.image.startsWith('http') ? 
                product.image : 
                `/${product.image}`;
            
            const productCard = document.createElement('div');
            productCard.className = 'product-card';
            productCard.dataset.id = product.id;
            productCard.innerHTML = `
                <div class="card-header">
                    <h3>${product.name}</h3>
                    <img src="${imagePath}" alt="${product.name}" class="product-image" 
                        onerror="this.onerror=null; this.src='https://placehold.co/300x200?text=Product+Image'"></div>
                <div class="card-body">
                    <p class="price">$${product.price}</p>
                    <p class="description">${product.description}</p>
                    ${product.category ? `<p class="category">Category: ${product.category}</p>` : ''}
                    
                    <div class="product-stock ${stockClass}">
                        ${stockStatus}
                    </div>
                    
                    <div class="card-buttons">
                        <button class="view-btn">View Details</button>
                        <button class="card-add-to-cart" data-id="${product.id}" 
                            ${product.stock <= 0 ? 'disabled' : ''}>
                            ${product.stock <= 0 ? 'Out of Stock' : 'Add to Cart'}
                        </button>
                    </div>
                </div>
            `;
            productsGrid.appendChild(productCard);
            
            // Add event listeners
            productCard.querySelector('.view-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                showProductDetail(product);
            });

            const addToCartBtn = productCard.querySelector('.card-add-to-cart');
            if (addToCartBtn && product.stock > 0) {
                addToCartBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    window.addToCart(product); // Use the global addToCart function from script.js
                    
                    // Visual feedback
                    addToCartBtn.textContent = "Added!";
                    setTimeout(() => {
                        if (product.stock > 0) {
                            addToCartBtn.textContent = "Add to Cart";
                        }
                    }, 2000);
                });
            }
        });
    }

    // Show product detail modal
    async function showProductDetail(product) {
        // If product is just an ID, fetch the full details
        if (typeof product === 'string') {
            const productRef = doc(db, 'products', product);
            const productSnap = await getDoc(productRef);
            if (!productSnap.exists()) return;
            product = { id: productSnap.id, ...productSnap.data() };
        }
        
        // Create overlay
        const overlay = document.createElement('div');
        overlay.className = 'tile-overlay active';
        document.body.appendChild(overlay);
        
        // Create detail tile
        const detailTile = document.createElement('div');
        detailTile.className = 'product-detail-tile active';
        detailTile.dataset.id = product.id;
        detailTile.innerHTML = `
            <button class="close-tile">√ó</button>
            <div class="tile-content">
                <div class="product-images">
                    <img src="${product.image}" alt="${product.name}" class="detail-image"
                        onerror="this.src='https://placehold.co/300x200?text=Product+Image'">
                    <div class="thumbnail-container">
                        <!-- Thumbnails would go here -->
                    </div>
                </div>
                <div class="product-info">
                    <h2>${product.name}</h2>
                    <p class="price">$${product.price}</p>
                    <p class="product-description">${product.description}</p>
                    
                    <div class="product-options">
                        <div class="option-group">
                            <label>Size:</label>
                            <div class="option-selector">
                                <div class="option-item selected">Small</div>
                                <div class="option-item">Medium</div>
                                <div class="option-item">Large</div>
                            </div>
                        </div>
                        
                        <div class="option-group">
                            <label>Color:</label>
                            <div class="option-selector">
                                <div class="option-item selected">White</div>
                                <div class="option-item">Green</div>
                                <div class="option-item">Brown</div>
                            </div>
                        </div>
                        
                        <div class="option-group">
                            <label>Quantity:</label>
                            <div class="quantity-selector">
                                <button class="quantity-btn minus">-</button>
                                <input type="number" value="1" min="1" max="${product.stock}" class="quantity-input">
                                <button class="quantity-btn plus">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn add-to-cart-btn" ${product.stock <= 0 ? 'disabled' : ''}>
                        ${product.stock <= 0 ? 'Out of Stock' : 'Add to Cart'}
                    </button>
                    <a href="product-detail.html?id=${product.id}" class="btn btn-outline">View Full Details</a>
                </div>
            </div>
        `;
        document.body.appendChild(detailTile);
        
        // Add event listeners for option selection
        detailTile.querySelectorAll('.option-item').forEach(item => {
            item.addEventListener('click', function() {
                this.parentNode.querySelectorAll('.option-item').forEach(i => 
                    i.classList.remove('selected'));
                this.classList.add('selected');
            });
        });
        
        // Quantity controls
        detailTile.querySelector('.minus').addEventListener('click', () => {
            const input = detailTile.querySelector('.quantity-input');
            if (input.value > 1) input.value--;
        });
        
        detailTile.querySelector('.plus').addEventListener('click', () => {
            const input = detailTile.querySelector('.quantity-input');
            if (parseInt(input.value) < product.stock) input.value++;
        });
        
        // Add to cart from detail view
        const addToCartBtn = detailTile.querySelector('.add-to-cart-btn');
        if (addToCartBtn && product.stock > 0) {
            addToCartBtn.addEventListener('click', function() {
                const quantity = parseInt(detailTile.querySelector('.quantity-input').value);
                const selectedSize = detailTile.querySelector('.option-group:nth-child(1) .selected').textContent;
                const selectedColor = detailTile.querySelector('.option-group:nth-child(2) .selected').textContent;
                
                const productWithOptions = {
                    ...product,
                    quantity,
                    options: {
                        size: selectedSize,
                        color: selectedColor
                    }
                };
                
                window.addToCart(productWithOptions); // Use the global addToCart function from script.js
                this.textContent = "Added to Cart!";
                setTimeout(() => {
                    detailTile.remove();
                    overlay.remove();
                }, 1500);
            });
        }
        
        // Close functionality
        detailTile.querySelector('.close-tile').addEventListener('click', () => {
            detailTile.remove();
            overlay.remove();
        });
        
        overlay.addEventListener('click', () => {
            detailTile.remove();
            overlay.remove();
        });
    }

    // Helper function for stock status
    function getStockClass(stock) {
        if (stock > 20) return 'in-stock';
        if (stock > 0) return 'low-stock';
        return 'out-of-stock';
    }

    function getStockText(stock) {
        if (stock > 20) return 'In Stock';
        if (stock > 0) return `Low Stock (${stock} left)`;
        return 'Out of Stock';
    }
</script>
<script src="script.js" type="module"></script>
</body>
</html>